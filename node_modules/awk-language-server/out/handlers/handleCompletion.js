"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCompletionHandler = void 0;
const completion_1 = require("../completion");
const utils_1 = require("../utils");
function notNamespace(symbolInfo) {
    return !!symbolInfo.containerName;
}
function getNamespaceUnderCursor(namespaces, position) {
    for (const [ns, range] of [...namespaces]) {
        if (utils_1.isPositionWithinRange(position, range))
            return ns;
    }
    return 'awk';
}
function getCompletionHandler(context) {
    const { symbols, namespaces, dependencies } = context;
    return function handleCompletion(params) {
        const { textDocument, position } = params;
        const namespaceUnderCursor = getNamespaceUnderCursor(namespaces[textDocument.uri], position);
        const allDeps = dependencies.getAllBreadthFirst(params.textDocument.uri);
        const allSymbols = [...allDeps]
            .filter((uri) => symbols[uri])
            .flatMap((uri) => [...symbols[uri].values()].flat())
            .filter(notNamespace);
        return allSymbols
            .map((si) => completion_1.symbolInfoToCompletionItem(si, namespaceUnderCursor))
            .concat(completion_1.getPredefinedCompletionItems());
    };
}
exports.getCompletionHandler = getCompletionHandler;
//# sourceMappingURL=handleCompletion.js.map